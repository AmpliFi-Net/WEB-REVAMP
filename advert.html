<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advert (AmpliFi)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small animations for cards */
    .fade-card { animation: fadeCard .45s ease-out both; }
    @keyframes fadeCard { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform: translateY(0); } }

    /* animated gradient headline */
    .gradient-animated {
      background: linear-gradient(90deg,#06b6d4,#34d399,#60a5fa);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: shimmer 3s linear infinite;
    }
    @keyframes shimmer {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    /* small pill */
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; }

    /* hide body overflow for safety in case of embedding */
    body { margin:0; padding:0; background:transparent; }
  </style>
</head>
<body>
  <!-- IMPORTANT: when this file has no content to show, do NOT output #advert-content (login.html will hide the section). -->
  <div id="advert-content" class="max-w-4xl mx-auto p-4"></div>

  <script>
  (function() {
    // --- CONFIG ---
    const SCOREBAT_API = 'https://www.scorebat.com/video-api/v3/feed/?token=MTExNjNfMTcwNzQwMTg0Nl85MzhiYjRlMGI3MjVkZWEzMTU2ZTlmNGZmYmUyYjM1YjI1OTFkYzFh';
    // Competitions we prioritise (case-insensitive substrings)
    const PRIORITY_LEAGUES = [
      'Premier League', 'EPL',               // England
      'UEFA Champions League', 'Champions League',
      'LaLiga', 'Primera Division',          // Spain
      'Serie A', 'Lega Serie A',             // Italy
      'Bundesliga',                           // Germany
      'Kenya Premier League', 'Kenyan', 'Kenya' // Kenyan matches - ScoreBat may not have them but we include
    ];
    // Holidays (MM-DD). We show the holiday message one day before the date in Africa/Nairobi timezone.
    const HOLIDAYS = {
      "01-01": { title: "🎆 Happy New Year!", message: "Start the year connected with AmpliFi WiFi!" },
      "06-01": { title: "👨‍👩‍👧‍👦 Madaraka Day", message: "Celebrate Kenya’s self-rule — enjoy reliable internet!" },
      "10-09": { title: "🌿 Mazingira Day", message: "Mazingira Day — go green and stay connected!" },
      "10-20": { title: "🇰🇪 Mashujaa Day", message: "Tomorrow is Mashujaa Day — celebrate Kenya’s heroes with AmpliFi!" },
      "12-12": { title: "🎉 Jamhuri Day", message: "Jamhuri Day celebrations — stay online and share the joy!" },
      "12-25": { title: "🎄 Merry Christmas!", message: "Merry Christmas! Stream and share festive moments with AmpliFi." },
      "12-31": { title: "🎊 Happy New Year's Eve!", message: "Get ready for the new year — stay connected with AmpliFi!" }
    };
    // How many matches to show max
    const MAX_MATCHES = 5;

    // Utility: format date/time in Nairobi timezone
    function toNairobiDateObj(isoString) {
      // parse iso string into Date then format components for Africa/Nairobi
      try {
        const d = new Date(isoString);
        // Use Intl to get date parts in Africa/Nairobi
        const fmt = new Intl.DateTimeFormat('en-GB', { timeZone: 'Africa/Nairobi', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false });
        const parts = fmt.formatToParts(d).reduce((acc,p)=> (acc[p.type]=p.value,acc), {});
        // return object with day key and time
        const yyyy = parts.year, mm = parts.month, dd = parts.day;
        const time = parts.hour + ':' + parts.minute;
        const dateStr = `${yyyy}-${mm}-${dd}`;
        return { dateStr, time };
      } catch(e) {
        // fallback: naive conversion (client timezone)
        const d = new Date(isoString);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        const min = String(d.getMinutes()).padStart(2,'0');
        return { dateStr: `${yyyy}-${mm}-${dd}`, time: `${hh}:${min}` };
      }
    }

    // Get today's and tomorrow's MM-DD in Nairobi timezone
    function getNairobiMMDD(offsetDays = 0) {
      const now = new Date();
      // convert to Nairobi time by creating string via Intl and re-parsing
      const parts = new Intl.DateTimeFormat('en-GB', { timeZone:'Africa/Nairobi', year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(now).reduce((a,p)=> (a[p.type]=p.value,a), {});
      const yyyy = Number(parts.year), mm = Number(parts.month), dd = Number(parts.day);
      // build Date in Nairobi local time by constructing Date with yyyy,mm-1,dd then add offsetDays
      const nairobiDate = new Date(Date.UTC(yyyy, mm-1, dd));
      nairobiDate.setUTCDate(nairobiDate.getUTCDate() + offsetDays);
      const mmS = String(nairobiDate.getUTCMonth()+1).padStart(2,'0');
      const ddS = String(nairobiDate.getUTCDate()).padStart(2,'0');
      return `${mmS}-${ddS}`;
    }

    // Check if competition is priority
    function isPriorityCompetition(name) {
      if (!name) return false;
      const n = name.toLowerCase();
      return PRIORITY_LEAGUES.some(p => n.includes(p.toLowerCase()));
    }

    // Build small match card HTML
    function matchCardHtml(m, nairobiTime) {
      const comp = m.competition && (m.competition.name || m.competition) || m.title || '';
      const title = m.title || comp;
      const url = m.matchviewUrl || m.url || '#';
      const score = (m.side1 && m.side2) ? `${m.side1}-${m.side2}` : (m.score || '');
      const timeTxt = nairobiTime || (m.date ? new Date(m.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '');
      return `
        <div class="bg-white rounded-2xl shadow-lg p-4 mb-4 fade-card">
          <div class="flex items-center justify-between">
            <div class="text-left">
              <div class="text-sm text-gray-500 mb-1">${comp}</div>
              <div class="text-lg font-semibold text-gray-800">${title}</div>
              <div class="text-sm text-gray-600 mt-1">Kickoff: ${timeTxt}</div>
            </div>
            <div class="text-right">
              <div class="pill bg-gray-100 text-gray-800">${score || '—'}</div>
              <div class="mt-3">
                <a class="inline-block text-sm text-blue-600 hover:underline" href="${url}" target="_blank" rel="noopener">View</a>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Render holiday card
    function holidayHtml(h) {
      return `
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-4 fade-card">
          <h3 class="text-2xl font-extrabold gradient-animated mb-2">${h.title}</h3>
          <p class="text-gray-700">${h.message}</p>
        </div>
      `;
    }

    // Main load function
    async function loadAdvert() {
      const container = document.getElementById('advert-content');
      container.innerHTML = ''; // clear

      // Determine if tomorrow is a holiday (we show holiday the day before)
      const tomorrowMMDD = getNairobiMMDD(1);
      const holidayTomorrow = HOLIDAYS[tomorrowMMDD];

      // We'll collect outputs into arrays
      const holidayBlocks = [];
      const matchBlocks = [];

      // If holiday tomorrow, show it
      if (holidayTomorrow) {
        holidayBlocks.push(holidayHtml(holidayTomorrow));
      }

      // Try fetch ScoreBat feed and filter today's matches (Nairobi date)
      let fetchedMatches = [];
      try {
        const resp = await fetch(SCOREBAT_API, { cache: "no-store" });
        if (resp.ok) {
          const json = await resp.json();
          // ScoreBat v3 returns an array under response
          const items = json.response || json;
          // Filter to matches happening today in Nairobi
          const todayMMDD = getNairobiMMDD(0);
          for (const m of (items || [])) {
            if (!m.date) continue;
            // convert m.date to Nairobi date string yyyy-mm-dd and time
            const dobj = toNairobiDateObj(m.date);
            const mmdd = dobj.dateStr.slice(5); // MM-DD
            if (mmdd === todayMMDD) {
              // Determine competition name if available
              // ScoreBat items sometimes include 'competition' object or embed competition in title
              let compName = '';
              if (m.competition) compName = (m.competition.name || m.competition);
              // push enriched match
              fetchedMatches.push({ ...m, compName, nairobiTime: dobj.time });
            }
          }
        } else {
          console.warn('ScoreBat fetch not ok:', resp.status);
        }
      } catch (e) {
        console.error('ScoreBat fetch error', e);
      }

      // Prioritize matches in priority leagues
      const priorityMatches = fetchedMatches.filter(m => {
        const compCheck = (m.competition && (m.competition.name || m.competition)) || m.title || '';
        return isPriorityCompetition(compCheck) || isPriorityCompetition(m.title || '');
      });

      // Build display order: priorityMatches first, then other matches (limit MAX_MATCHES)
      const ordered = [...priorityMatches, ...fetchedMatches.filter(m => !priorityMatches.includes(m))].slice(0, MAX_MATCHES);

      for (const m of ordered) {
        const d = toNairobiDateObj(m.date);
        matchBlocks.push(matchCardHtml(m, d.time));
      }

      // If we have at least one holiday or at least one match, render them
      if (holidayBlocks.length || matchBlocks.length) {
        // Build combined layout: holiday on left (if present), matches on right — but since this file is embedded inline
        // We'll create a responsive stacked layout
        let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
        // If holiday exists, show as left column; if none, left column can be matches too
        html += '<div>';
        if (holidayBlocks.length) {
          html += holidayBlocks.join('');
        } else if (matchBlocks.length && matchBlocks.length <= 2) {
          // If no holiday but few matches, show first match prominent here
          html += matchBlocks.shift() || '';
        }
        html += '</div>';

        // Right column: remaining matches
        html += '<div>';
        if (matchBlocks.length) {
          html += matchBlocks.join('');
        }
        html += '</div>';

        html += '</div>';

        // Attach to container (wrapped within an outer card)
        container.innerHTML = `
          <div class="bg-gradient-to-r from-white/60 to-white/40 border border-gray-200 rounded-3xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl md:text-3xl font-extrabold text-gray-800"> <span class="gradient-animated">AmpliFi • Today</span> </h2>
              <div class="text-sm text-gray-500">Kenya time (EAT)</div>
            </div>
            ${html}
          </div>
        `;
        return; // done - we rendered something
      }

      // If we get here -> no holiday tomorrow AND no matches today => do not render #advert-content
      // Remove the advert-content container entirely so login.html won't append it
      container.remove(); // this causes login.html parser to find no #advert-content and it will hide the section
    }

    // initial run + refresh every 3 hours
    loadAdvert();
    setInterval(loadAdvert, 3 * 60 * 60 * 1000);
  })();
  </script>
</body>
</html>
